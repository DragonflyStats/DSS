---
title: "Reproducible Research: Peer Assessment 1"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r, echo=FALSE, results='hide', warning=FALSE, message=FALSE}
library(ggplot2)
library(scales)
library(tidyverse)
library(magrittr)
library(lubridate)

```

## Part 1 Loading and preprocessing the data

#### 1.A. Load the data (i.e. readr::read_csv())

```{r, results='markup', warning=TRUE, message=TRUE}
if(!file.exists('activity.csv')){
    unzip('activity.zip')
}
activityData <- read_csv('activity.csv',show_col_types = FALSE)

```

#### 1.B Additional Preprocessing Steps

*Process/transform the data (if necessary) into a format suitable for your analysis* 
* Looking ahead, we will need to create a time stamp variable using a transformation of the intervals variable.
* We will also transform the time variable into a timelapse format that is convenient for making time-series plots.

```{r}
activityData$interval <- activityData$interval

activityData$time <- sprintf("%04.0f", activityData$interval)
activityData$time <- gsub("([0-9]{1,2})([0-9]{2})", "\\1:\\2", activityData$time)




```

```{r}
# time since start of day in units of seconds
# - 86,400 seconds in a day
activityData$timelapse_sec <- as.numeric(hm(activityData$time))

# time since start of day in units of 5 minutes
# - 288 five-minute periods in a day
activityData$timelapse_5mins <- as.numeric(hm(activityData$time))/300

# Create Day and Hour Variables for Imputation 
activityData <- activityData %>% mutate( Day = wday(date))
activityData <- activityData %>% mutate( Hour = substr(time, start = 1, stop = 2))

#activityData$time <- strptime(activityData$time, "%H:%M")
#activityData$time <- data.table::as.ITime(activityData$time)
```

```{r}
tail(activityData,2)
```

## Part 2

### Exercise 2.a

*Calculate the total number of steps taken per day*

Working in units of daily step count

```{r}
daily_step_total <- activityData %>% 
    group_by(date) %>%  # using tidyverse
    summarise(daily_steps=sum(steps,na.rm=TRUE)) 

head(daily_step_total,12)
```

### Exercise 2.B

*Make a histogram of the total number of steps taken each day*

The approach to take using {ggplot2} is to apply <tt>geom_bar()</tt>, and apply it to the daily step totals

```{r}
activityData %>% group_by(date) %>% 
    summarise(steps=sum(steps,na.rm=TRUE)) %>% 
    ggplot(aes(x=date,y=steps)) + geom_bar(stat="identity")

```




### Exercise 2.C

*Calculate and report the mean and median total number of steps taken per day*


The mean and median of the daily step counts for the period can be found in the following summary.

```{r}
daily_step_summary <- daily_step_total%>% summarize(
    mean_daily_steps= mean(daily_steps),
    median_daily_steps = median(daily_steps),
    total_daily_steps = sum(daily_steps))

daily_step_summary
```

```{r}
Mean_Daily_Steps <- daily_step_summary %>% pull(mean_daily_steps)
Median_Daily_Steps <- daily_step_summary%>% pull(median_daily_steps)
Total_Daily_Steps <- daily_step_summary%>% pull(total_daily_steps)
```
* Mean: `r Mean_Daily_Steps`
* Median:  `r Median_Daily_Steps`
* Total:  `r Total_Daily_Steps`

-----

## Part 3 

**What is the average daily activity pattern?**

```{r}
mean_steps_per_interval <- activityData %>% 
    group_by(time) %>% 
    summarise(meanSteps = mean(steps,na.rm=TRUE))

mean_steps_per_interval$time = factor(mean_steps_per_interval$time,ordered=TRUE)

```

### Exercise 3.A

*Make a time series plot (i.e. <tt>type = "l")</tt> of the 5-minute interval (x-axis) and the average number of steps taken, averaged across all days (y-axis)* 

```{r}
mean_steps_per_interval %>%
    ggplot(aes(x=time, y=meanSteps,group=1)) +
    geom_line(col="red") +
    xlab("5-minute intervals") +
    ylab("Average number of steps taken") +
    scale_x_discrete(breaks=mean_steps_per_interval$time[24*(1:11)+1])+
    theme_bw()
```

### Exercise 3.B

*Which 5-minute interval, on average across all the days in the dataset, contains the maximum number of steps?*

```{r}
max_steps <- which.max(mean_steps_per_interval$meanSteps)

time_max_steps <-activityData$time[max_steps]
```

* Most Steps at: `r time_max_steps`

----

## Part 4

### Imputing missing values

### Exercise 4.A

*Calculate and report the total number of missing values in the dataset*

```{r}
numMissingValues <- sum(is.na(activityData$steps))
```

* Number of missing values: `r numMissingValues`

##### 2. Devise a strategy for filling in all of the missing values in the dataset.


```{r}
dim(activityData)
```

```{r}
impute_data <- activityData %>% group_by(Day,Hour) %>% summarise(impute_steps=mean(steps,na.rm=TRUE)) %>% mutate(impute_steps=round(impute_steps))
impute_data
```
##### 3. Create a new dataset that is equal to the original dataset but with the missing data filled in.
```{r}
activityDataImputed <- activityData %>% 
    left_join(impute_data,by=c("Day","Hour")) %>%
    mutate(steps = coalesce(steps,impute_steps))
```

```{r}
head(activityDataImputed)
```


##### 4. Make a histogram of the total number of steps taken each day 
```{r}
stepsByDayImputed <- tapply(activityDataImputed$steps, activityDataImputed$date, sum)
qplot(stepsByDayImputed, xlab='Total steps per day (Imputed)', ylab='Frequency using binwith 500', binwidth=500)
```

##### ... and Calculate and report the mean and median total number of steps taken per day. 
```{r}
stepsByDayMeanImputed <- mean(stepsByDayImputed)
stepsByDayMedianImputed <- median(stepsByDayImputed)
```
* Mean (Imputed): `r stepsByDayMeanImputed`
* Median (Imputed):  `r stepsByDayMedianImputed`


----

## Are there differences in activity patterns between weekdays and weekends?

##### 1. Create a new factor variable in the dataset with two levels – “weekday” and “weekend” indicating whether a given date is a weekday or weekend day.

```{r}
activityDataImputed$dateType <- ifelse(as.POSIXlt(activityDataImputed$date)$wday %in% c(0,6), 'weekend', 'weekday')
```

##### 2. Make a panel plot containing a time series plot

```{r}
averagedActivityDataImputed <- aggregate(steps ~ interval + dateType, data=activityDataImputed, mean)

ggplot(averagedActivityDataImputed, aes(interval, steps)) + 
    geom_line() + 
    facet_grid(dateType ~ .) +
    xlab("5-minute interval") + 
    ylab("avarage number of steps")
```